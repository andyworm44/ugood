# ğŸ—„ï¸ Supabase Storage è¨­ç½®æŒ‡å—

## ğŸ“‹ å‰ç½®è¦æ±‚

åœ¨ä½¿ç”¨éŸ³é »ä¸Šå‚³åŠŸèƒ½ä¹‹å‰ï¼Œæ‚¨éœ€è¦åœ¨ Supabase ä¸­è¨­ç½® Storage bucketã€‚

## ğŸš€ è¨­ç½®æ­¥é©Ÿ

### 1. ç™»å…¥ Supabase Dashboard

1. å‰å¾€ [Supabase Dashboard](https://app.supabase.com)
2. é¸æ“‡æ‚¨çš„ UGood é …ç›®

### 2. å‰µå»º Storage Bucket

1. åœ¨å·¦å´å°èˆªæ¬„é»æ“Š **"Storage"**
2. é»æ“Š **"Create a new bucket"** æˆ– **"New Bucket"**
3. å¡«å¯«ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **Bucket name**: `audio-files`
   - **Public bucket**: âœ… **å•Ÿç”¨** (å‹¾é¸æ­¤é¸é …è®“éŸ³é »æ–‡ä»¶å¯å…¬é–‹è¨ªå•)
4. é»æ“Š **"Create bucket"**

### 3. è¨­ç½® Bucket æ”¿ç­– (RLS)

å› ç‚ºæˆ‘å€‘å•Ÿç”¨äº†å…¬é–‹è¨ªå•ï¼Œä½†ä»éœ€è¦è¨­ç½®é©ç•¶çš„å®‰å…¨è¦å‰‡ï¼š

1. é»æ“Šå‰›å‰µå»ºçš„ `audio-files` bucket
2. å‰å¾€ **"Policies"** æ¨™ç±¤
3. é»æ“Š **"New Policy"**

#### å…è¨±èªè­‰ç”¨æˆ¶ä¸Šå‚³æ”¿ç­–

```sql
-- æ”¿ç­–åç¨±: "Authenticated users can upload"
-- æ“ä½œ: INSERT
-- ç›®æ¨™è§’è‰²: authenticated

-- æ”¿ç­–è¡¨é”å¼:
bucket_id = 'audio-files' AND auth.role() = 'authenticated'
```

#### å…è¨±å…¬é–‹è®€å–æ”¿ç­–

```sql
-- æ”¿ç­–åç¨±: "Public can download"
-- æ“ä½œ: SELECT
-- ç›®æ¨™è§’è‰²: public

-- æ”¿ç­–è¡¨é”å¼:
bucket_id = 'audio-files'
```

### 4. è¨­ç½®æ–‡ä»¶å¤§å°é™åˆ¶ (å¯é¸)

åœ¨ **"Settings"** æ¨™ç±¤ä¸­ï¼Œæ‚¨å¯ä»¥è¨­ç½®ï¼š
- **File size limit**: å»ºè­°è¨­ç‚º `50MB` (éŸ³é »æ–‡ä»¶é€šå¸¸ä¸æœƒè¶…éæ­¤å¤§å°)
- **Allowed MIME types**: `audio/*` (åƒ…å…è¨±éŸ³é »æ–‡ä»¶)

## ğŸ§ª æ¸¬è©¦è¨­ç½®

### ä½¿ç”¨ Supabase CLI æ¸¬è©¦ (å¯é¸)

```bash
# å®‰è£ Supabase CLI
npm install -g supabase

# ç™»å…¥
supabase login

# æ¸¬è©¦ä¸Šå‚³
supabase storage upload audio-files test.mp3 /path/to/test.mp3
```

### åœ¨æ‡‰ç”¨ä¸­æ¸¬è©¦

1. å•Ÿå‹•æ‚¨çš„ UGood æ‡‰ç”¨
2. è¨»å†Š/ç™»å…¥å¸³è™Ÿ
3. å‰å¾€éŒ„éŸ³é é¢
4. éŒ„è£½ä¸€æ®µçŸ­éŸ³é »
5. é»æ“Š **"ç™¼é€ç¥ç¦èªéŸ³"**
6. æª¢æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ä¸Šå‚³æˆåŠŸçš„æ—¥èªŒ

## ğŸ“Š ç›£æ§èˆ‡ç®¡ç†

### æŸ¥çœ‹ä¸Šå‚³çš„æ–‡ä»¶

åœ¨ Supabase Dashboard çš„ Storage éƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥ï¼š
- æŸ¥çœ‹æ‰€æœ‰ä¸Šå‚³çš„éŸ³é »æ–‡ä»¶
- ç›£æ§å­˜å„²ä½¿ç”¨é‡
- ç®¡ç†æ–‡ä»¶ï¼ˆä¸‹è¼‰ã€åˆªé™¤ç­‰ï¼‰

### æ–‡ä»¶å‘½åè¦ç¯„

æ‡‰ç”¨æœƒè‡ªå‹•ç”Ÿæˆå”¯ä¸€çš„æ–‡ä»¶åï¼š
```
blessing_{user_id}_{timestamp}_{random_id}.m4a
```

ä¾‹å¦‚ï¼š`blessing_abc123_1703947935_x7y9z.m4a`

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. ä¸Šå‚³å¤±æ•— - æ¬Šé™éŒ¯èª¤
**éŒ¯èª¤**: `new row violates row-level security policy`

**è§£æ±ºæ–¹æ¡ˆ**:
- ç¢ºèªæ‚¨å·²è¨­ç½®æ­£ç¢ºçš„ RLS æ”¿ç­–
- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²èªè­‰

#### 2. æ–‡ä»¶ç„¡æ³•è¨ªå•
**éŒ¯èª¤**: `The resource you are looking for could not be found`

**è§£æ±ºæ–¹æ¡ˆ**:
- ç¢ºèª bucket å·²è¨­ç‚º public
- æª¢æŸ¥æ–‡ä»¶æ˜¯å¦ç¢ºå¯¦ä¸Šå‚³æˆåŠŸ

#### 3. æ–‡ä»¶å¤§å°éå¤§
**éŒ¯èª¤**: `Payload too large`

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶è¨­ç½®
- è€ƒæ…®å£“ç¸®éŸ³é »æ–‡ä»¶

### æª¢æŸ¥é…ç½®

ç¢ºèªæ‚¨çš„ `supabase.config.js` ä¸­çš„è¨­ç½®æ­£ç¢ºï¼š

```javascript
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false
  }
});
```

## ğŸ“ˆ æ“´å±•åŠŸèƒ½

### éŸ³é »æ–‡ä»¶è™•ç†

æ‚¨å¯ä»¥è€ƒæ…®æ·»åŠ ï¼š
- éŸ³é »å£“ç¸®
- æ ¼å¼è½‰æ›
- éŸ³è³ªå„ªåŒ–
- è‡ªå‹•è½‰éŒ„

### å®‰å…¨å¢å¼·

- è¨­ç½®æ–‡ä»¶æƒæ¯’
- å…§å®¹å¯©æ ¸
- é€Ÿç‡é™åˆ¶
- ç”¨æˆ¶é…é¡ç®¡ç†

---

## âœ… å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] å‰µå»º `audio-files` bucket
- [ ] è¨­ç½®ç‚ºå…¬é–‹ bucket
- [ ] é…ç½®ä¸Šå‚³æ¬Šé™æ”¿ç­–
- [ ] é…ç½®è®€å–æ¬Šé™æ”¿ç­–
- [ ] è¨­ç½®æ–‡ä»¶å¤§å°é™åˆ¶
- [ ] æ¸¬è©¦ä¸Šå‚³åŠŸèƒ½
- [ ] æ¸¬è©¦æ’­æ”¾åŠŸèƒ½
- [ ] æª¢æŸ¥æ–‡ä»¶èƒ½æ­£å¸¸è¨ªå•

å®Œæˆä»¥ä¸Šæ­¥é©Ÿå¾Œï¼Œæ‚¨çš„ UGood æ‡‰ç”¨å°±èƒ½å®Œæ•´åœ°æ”¯æŒéŸ³é »ä¸Šå‚³å’Œæ’­æ”¾åŠŸèƒ½äº†ï¼ğŸ‰